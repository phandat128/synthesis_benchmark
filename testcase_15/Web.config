<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.web>
    <!-- SECURITY: Set debug to false in production to prevent detailed error leakage -->
    <compilation debug="true" targetFramework="4.8" />
    <httpRuntime targetFramework="4.8" 
                 enableVersionHeader="false" 
                 maxRequestLength="5120" /> <!-- Max 5MB (5120 KB) for the entire request -->

    <!-- SECURITY: Custom errors prevent detailed stack traces from being shown to users -->
    <customErrors mode="RemoteOnly" defaultRedirect="~/Error/GenericError">
      <error statusCode="404" redirect="~/Error/NotFound" />
      <error statusCode="500" redirect="~/Error/InternalError" />
    </customErrors>

    <!-- SECURITY: Require authentication for all pages unless explicitly allowed -->
    <authentication mode="Forms">
      <forms loginUrl="~/Account/Login" timeout="2880" />
    </authentication>
    <authorization>
      <deny users="?" />
    </authorization>
    
    <pages>
      <namespaces>
        <add namespace="System.Web.Mvc" />
        <add namespace="System.Web.Mvc.Ajax" />
        <add namespace="System.Web.Mvc.Html" />
        <add namespace="System.Web.Routing" />
        <add namespace="System.Web.Optimization" />
      </namespaces>
    </pages>
  </system.web>

  <system.webServer>
    <validation validateIntegratedModeConfiguration="false" />
    <modules runAllManagedModulesForAllRequests="true" />
    
    <!-- SECURITY: Enforce request filtering limits (5MB) -->
    <security>
      <requestFiltering>
        <requestLimits maxAllowedContentLength="5242880" />
      </requestFiltering>
    </security>
  </system.webServer>

  <!-- SECURITY: Location configuration to explicitly deny script execution in the upload folder -->
  <!-- This is a defense-in-depth measure against RCE, complementing filename sanitization. -->
  <location path="Content/Avatars">
    <system.web>
      <!-- Deny all handlers and modules that might execute scripts -->
      <httpHandlers>
        <clear />
      </httpHandlers>
      <httpModules>
        <clear />
      </httpModules>
    </system.web>
    <system.webServer>
      <!-- Remove all handlers (especially script handlers like ASP.NET ones) -->
      <handlers>
        <clear />
        <!-- Add a static file handler to ensure files are only served, not executed -->
        <add name="StaticFileHandler" path="*" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
      </handlers>
    </system.webServer>
  </location>
  
  <runtime>
    <assemblyBinding xmlns="urn:schemas-microsoft-com:asm.v1">
      <!-- Assembly binding redirects omitted for brevity -->
    </assemblyBinding>
  </runtime>
</configuration>